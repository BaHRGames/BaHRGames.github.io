<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- –°—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏ Firebase –±–µ–∑ ES6 –º–æ–¥—É–ª–µ–π -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            transition: all 0.3s ease;
            min-height: 100vh;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 16px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--tg-theme-hint-color, #cccccc);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid var(--tg-theme-button-color, #2481cc);
        }

        .input-section {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .post-input {
            width: 100%;
            min-height: 60px;
            padding: 12px;
            border: none;
            border-radius: 12px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            font-size: 16px;
            resize: none;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .post-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--tg-theme-button-color, #2481cc);
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border-radius: 20px;
            cursor: pointer;
            transition: opacity 0.3s;
            font-size: 14px;
        }

        .file-input-label:hover {
            opacity: 0.9;
        }

        #fileInput {
            display: none;
        }

        .anonym-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--tg-theme-text-color, #000000);
            font-size: 14px;
        }

        .toggle-switch {
            position: relative;
            width: 40px;
            height: 20px;
        }

        .toggle-checkbox {
            display: none;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        .toggle-checkbox:checked + .toggle-slider {
            background-color: var(--tg-theme-button-color, #2481cc);
        }

        .toggle-checkbox:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .send-button {
            padding: 8px 24px;
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: opacity 0.3s;
        }

        .send-button:hover {
            opacity: 0.9;
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--tg-theme-hint-color, #cccccc);
            overflow-x: auto;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid var(--tg-theme-button-color, #2481cc);
            border-radius: 20px;
            background: transparent;
            color: var(--tg-theme-button-color, #2481cc);
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .posts-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding-bottom: 80px;
        }

        .post {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 16px;
            padding: 16px;
            animation: fadeIn 0.5s ease;
            transition: transform 0.3s ease;
        }

        .post:hover {
            transform: translateY(-2px);
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .post-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
        }

        .post-user-info {
            flex: 1;
        }

        .post-username {
            font-weight: 600;
            color: var(--tg-theme-text-color, #000000);
            cursor: pointer;
            margin-bottom: 2px;
        }

        .post-time {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #666666);
        }

        .post-content {
            margin-bottom: 12px;
            line-height: 1.5;
            color: var(--tg-theme-text-color, #000000);
        }

        .post-image {
            width: 100%;
            border-radius: 12px;
            margin-bottom: 12px;
            max-height: 400px;
            object-fit: cover;
            cursor: pointer;
        }

        .post-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        .reactions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .reaction-btn {
            padding: 4px 12px;
            border: 1px solid var(--tg-theme-hint-color, #cccccc);
            border-radius: 16px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.3s ease;
        }

        .reaction-btn:hover {
            transform: scale(1.05);
        }

        .reaction-btn.liked {
            border-color: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-color, #2481cc);
        }

        .boost-btn {
            padding: 6px 16px;
            background: linear-gradient(45deg, #ff6b00, #ff9500);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255, 107, 0, 0.3);
        }

        .boost-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 107, 0, 0.4);
        }

        .boost-btn.boosted {
            background: linear-gradient(45deg, #00c6ff, #0072ff);
        }

        .hot-badge {
            display: inline-block;
            padding: 4px 8px;
            background: linear-gradient(45deg, #ff3366, #ff6633);
            color: white;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--tg-theme-hint-color, #666666);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--tg-theme-hint-color, #666666);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .image-preview {
            position: relative;
            margin-bottom: 12px;
        }

        .preview-image {
            width: 100%;
            border-radius: 12px;
            max-height: 200px;
            object-fit: cover;
        }

        .remove-preview {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--tg-theme-secondary-bg-color, #333);
            color: var(--tg-theme-text-color, #fff);
            padding: 12px 24px;
            border-radius: 20px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .toast.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1></h1>
            <img id="userAvatar" class="user-avatar" src="" alt="Avatar" onclick="openTelegramProfile()">
        </div>

        <div class="input-section">
            <textarea class="post-input" id="postInput" placeholder="–ß—Ç–æ —É –≤–∞—Å –Ω–æ–≤–æ–≥–æ?..." maxlength="500"></textarea>
            
            <div id="imagePreview" class="image-preview"></div>
            
            <div class="controls">
                <label class="file-input-label">
                    üì∑ –§–æ—Ç–æ
                    <input type="file" id="fileInput" accept="image/*" capture="environment">
                </label>
                
                <div class="anonym-toggle">
                    <span>–ê–Ω–æ–Ω–∏–º–Ω–æ</span>
                    <div class="toggle-switch">
                        <input type="checkbox" id="anonToggle" class="toggle-checkbox">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                
                <button class="send-button" id="sendBtn" onclick="sendPost()" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>

        <div class="filters">
            <button class="filter-btn active" onclick="setFilter('all')">–í—Å–µ</button>
            <button class="filter-btn" onclick="setFilter('boosted')">üî• –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ</button>
        </div>

        <div class="posts-container" id="postsContainer">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...</div>
        </div>

        <div class="toast" id="toast"></div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        const firebaseConfig = {
            databaseURL: "https://flum-2-default-rtdb.firebaseio.com/"
        };
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –ª–∏ firebase
        if (typeof firebase === 'undefined') {
            console.error("Firebase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!");
            document.getElementById('postsContainer').innerHTML = 
                '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Firebase. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.</div>';
        } else {
            firebase.initializeApp(firebaseConfig);
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        let tg = null;
        if (window.Telegram && window.Telegram.WebApp) {
            tg = window.Telegram.WebApp;
            tg.expand();
            if (tg.BackButton && tg.BackButton.hide) {
                tg.BackButton.hide();
            }
        } else {
            console.warn("Telegram Web App –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω, –∑–∞–ø—É—Å–∫ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ");
            // –¢–µ—Å—Ç–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
            tg = {
                initDataUnsafe: {
                    user: {
                        id: 123456789,
                        username: "test_user",
                        first_name: "–¢–µ—Å—Ç",
                        last_name: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
                        photo_url: "https://i.pravatar.cc/150?img=3"
                    }
                },
                expand: function() {},
                openLink: function(url) { window.open(url, '_blank'); }
            };
        }
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let currentUser = null;
        let posts = [];
        let currentFilter = 'all';
        let selectedImage = null;
        let userReactions = {};
        let userBoosts = {};
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function initUser() {
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                currentUser = {
                    id: tg.initDataUnsafe.user.id.toString(),
                    username: tg.initDataUnsafe.user.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                    firstName: tg.initDataUnsafe.user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                    lastName: tg.initDataUnsafe.user.last_name || '',
                    photoUrl: tg.initDataUnsafe.user.photo_url || 'https://i.pravatar.cc/150?img=3'
                };
            } else {
                // –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                currentUser = {
                    id: 'anonymous_' + Date.now(),
                    username: '–ì–æ—Å—Ç—å',
                    firstName: '–ì–æ—Å—Ç—å',
                    lastName: '',
                    photoUrl: 'https://i.pravatar.cc/150?img=3'
                };
            }
            
            document.getElementById('userAvatar').src = currentUser.photoUrl;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∞–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            loadUserReactions();
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∞–∫—Ü–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function loadUserReactions() {
            if (!firebase.apps.length) return;
            
            const db = firebase.database();
            const userId = currentUser.id;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∞–∫—Ü–∏–∏
            db.ref('user_reactions/' + userId).once('value')
                .then(snapshot => {
                    userReactions = snapshot.val() || {};
                })
                .catch(error => {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∞–∫—Ü–∏–π:", error);
                });
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –±—É—Å—Ç—ã
            db.ref('user_boosts/' + userId).once('value')
                .then(snapshot => {
                    userBoosts = snapshot.val() || {};
                })
                .catch(error => {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±—É—Å—Ç–æ–≤:", error);
                });
        }
        
        // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è Data URL –≤ ImgBB —Å—Å—ã–ª–∫—É
        async function convertDataUrlToImgBB(dataUrl) {
            try {
                const apiKey = "02cf7a0dc37b8a8adaedc9784752a3db";
                
                // –ò–∑–≤–ª–µ–∫–∞–µ–º base64 –¥–∞–Ω–Ω—ã–µ
                const base64Data = dataUrl.split(',')[1];
                if (!base64Data) {
                    console.error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π Data URL");
                    return null;
                }
                
                // –°–æ–∑–¥–∞–µ–º FormData
                const formData = new FormData();
                formData.append('key', apiKey);
                formData.append('image', base64Data);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
                const response = await fetch("https://api.imgbb.com/1/upload", {
                    method: "POST",
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log("ImgBB –æ—Ç–≤–µ—Ç:", data);
                
                if (data.success && data.data && data.data.url) {
                    return data.data.url;
                } else {
                    console.error("ImgBB API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É:", data);
                    return null;
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ ImgBB:", error);
                return null;
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ—Å—Ç–∞
        async function sendPost() {
            const text = document.getElementById('postInput').value.trim();
            const isAnonymous = document.getElementById('anonToggle').checked;
            
            if (!text && !selectedImage) {
                showToast("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ");
                return;
            }
            
            if (!firebase.apps.length) {
                showToast("–û—à–∏–±–∫–∞: Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
                return;
            }
            
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞...";
            
            let imageUrl = null;
            if (selectedImage) {
                showToast("–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ...");
                imageUrl = await convertDataUrlToImgBB(selectedImage);
                if (!imageUrl) {
                    showToast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ");
                    sendBtn.disabled = false;
                    sendBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
                    return;
                }
            }
            
            const db = firebase.database();
            const postData = {
                userId: isAnonymous ? 'anonymous' : currentUser.id,
                username: isAnonymous ? '–ê–Ω–æ–Ω–∏–º' : (currentUser.username || currentUser.firstName),
                userPhoto: isAnonymous ? 'https://i.pravatar.cc/150?img=0' : currentUser.photoUrl,
                text: text,
                imageUrl: imageUrl,
                timestamp: Date.now(),
                reactions: {
                    'üëç': 0,
                    '‚ù§Ô∏è': 0,
                    'üòÇ': 0,
                    'üòÆ': 0
                },
                boosts: 0,
                boostedUsers: {}
            };
            
            try {
                const newPostRef = db.ref('posts').push();
                await newPostRef.set(postData);
                
                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                document.getElementById('postInput').value = '';
                removeImagePreview();
                selectedImage = null;
                sendBtn.disabled = true;
                
                showToast("‚úÖ –ü–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!");
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å—Ç—ã
                loadPosts();
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ—Å—Ç–∞:", error);
                showToast("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ—Å—Ç–∞");
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤
        function loadPosts() {
            if (!firebase.apps.length) {
                document.getElementById('postsContainer').innerHTML = 
                    '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Firebase</div>';
                return;
            }
            
            const postsContainer = document.getElementById('postsContainer');
            postsContainer.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...</div>';
            
            const db = firebase.database();
            
            db.ref('posts').orderByChild('timestamp').once('value')
                .then(snapshot => {
                    const postsData = snapshot.val();
                    
                    if (!postsData) {
                        postsContainer.innerHTML = '<div class="empty-state">–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>';
                        posts = [];
                        return;
                    }
                    
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ–±—ä–µ–∫—Ç –≤ –º–∞—Å—Å–∏–≤ –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                    posts = Object.entries(postsData).map(([id, post]) => ({
                        id,
                        ...post
                    })).sort((a, b) => b.timestamp - a.timestamp);
                    
                    renderPosts();
                })
                .catch(error => {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤:", error);
                    postsContainer.innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.</div>';
                });
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Å—Ç–æ–≤
        function renderPosts() {
            const postsContainer = document.getElementById('postsContainer');
            const filteredPosts = filterPosts();
            
            if (filteredPosts.length === 0) {
                postsContainer.innerHTML = '<div class="empty-state">–ù–µ—Ç –ø–æ—Å—Ç–æ–≤ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ñ–∏–ª—å—Ç—Ä—É</div>';
                return;
            }
            
            postsContainer.innerHTML = '';
            
            filteredPosts.forEach(post => {
                const postElement = createPostElement(post);
                postsContainer.appendChild(postElement);
            });
        }
        
        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–æ–≤
        function filterPosts() {
            if (currentFilter === 'all') {
                return posts;
            } else if (currentFilter === 'boosted') {
                // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ—Å—Ç—ã —Å –±—É—Å—Ç–∞–º–∏ –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –±—É—Å—Ç–æ–≤
                return [...posts]
                    .filter(post => post.boosts > 0)
                    .sort((a, b) => b.boosts - a.boosts || b.timestamp - a.timestamp);
            }
            return posts;
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–æ—Å—Ç–∞
        function createPostElement(post) {
            const postDiv = document.createElement('div');
            postDiv.className = 'post';
            
            const isHot = post.boosts >= 5; // –ü–æ—Ä–æ–≥ –¥–ª—è "–≥–æ—Ä—è—á–µ–≥–æ" –ø–æ—Å—Ç–∞
            
            let hotBadge = '';
            if (isHot && currentFilter === 'boosted') {
                hotBadge = '<span class="hot-badge">üî• –ì–û–†–Ø–ß–ò–ô</span>';
            }
            
            const time = new Date(post.timestamp).toLocaleString('ru-RU', {
                day: 'numeric',
                month: 'short',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∞–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userReaction = userReactions[post.id] || null;
            const hasBoosted = userBoosts[post.id] || false;
            
            let imageHtml = '';
            if (post.imageUrl) {
                imageHtml = `<img class="post-image" src="${post.imageUrl}" alt="Post image" onclick="openImage('${post.imageUrl.replace(/'/g, "\\'")}')">`;
            }
            
            // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è —Ä–µ–∞–∫—Ü–∏–π
            let reactionsHtml = '';
            const reactions = post.reactions || {};
            for (const [emoji, count] of Object.entries(reactions)) {
                const isLiked = userReaction === emoji;
                reactionsHtml += `
                    <button class="reaction-btn ${isLiked ? 'liked' : ''}" 
                            onclick="addReaction('${post.id}', '${emoji}')">
                        ${emoji} ${count || 0}
                    </button>
                `;
            }
            
            postDiv.innerHTML = `
                <div class="post-header">
                    <img class="post-avatar" src="${post.userPhoto || 'https://i.pravatar.cc/150?img=0'}" 
                         alt="${post.username || '–ê–Ω–æ–Ω–∏–º'}" 
                         onclick="openUserProfile('${post.userId || 'anonymous'}')">
                    <div class="post-user-info">
                        <div class="post-username" onclick="openUserProfile('${post.userId || 'anonymous'}')">
                            ${post.username || '–ê–Ω–æ–Ω–∏–º'} ${hotBadge}
                        </div>
                        <div class="post-time">${time}</div>
                    </div>
                </div>
                ${post.text ? `<div class="post-content">${escapeHtml(post.text)}</div>` : ''}
                ${imageHtml}
                <div class="post-stats">
                    <div class="reactions">
                        ${reactionsHtml}
                    </div>
                    <button class="boost-btn ${hasBoosted ? 'boosted' : ''}" 
                            onclick="boostPost('${post.id}')">
                        üî• ${post.boosts || 0}
                    </button>
                </div>
            `;
            
            return postDiv;
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∞–∫—Ü–∏–∏
        function addReaction(postId, emoji) {
            if (!currentUser || !firebase.apps.length) return;
            
            const db = firebase.database();
            const postRef = db.ref('posts/' + postId + '/reactions/' + emoji);
            const userReactionRef = db.ref('user_reactions/' + currentUser.id + '/' + postId);
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Ä–µ–∞–∫—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userReaction = userReactions[postId];
            
            if (userReaction === emoji) {
                // –£–¥–∞–ª—è–µ–º —Ä–µ–∞–∫—Ü–∏—é
                postRef.once('value')
                    .then(snapshot => {
                        const currentCount = snapshot.val() || 0;
                        return postRef.set(Math.max(0, currentCount - 1));
                    })
                    .then(() => userReactionRef.remove())
                    .then(() => {
                        delete userReactions[postId];
                        loadPosts();
                    })
                    .catch(error => console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ä–µ–∞–∫—Ü–∏–∏:", error));
            } else {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Ä–µ–∞–∫—Ü–∏—é
                const updatePromises = [];
                
                if (userReaction) {
                    const oldReactionRef = db.ref('posts/' + postId + '/reactions/' + userReaction);
                    updatePromises.push(
                        oldReactionRef.once('value')
                            .then(snapshot => {
                                const oldCount = snapshot.val() || 0;
                                return oldReactionRef.set(Math.max(0, oldCount - 1));
                            })
                    );
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Ä–µ–∞–∫—Ü–∏—é
                updatePromises.push(
                    postRef.once('value')
                        .then(snapshot => {
                            const currentCount = snapshot.val() || 0;
                            return postRef.set(currentCount + 1);
                        })
                );
                
                updatePromises.push(userReactionRef.set(emoji));
                
                Promise.all(updatePromises)
                    .then(() => {
                        userReactions[postId] = emoji;
                        loadPosts();
                    })
                    .catch(error => console.error("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∞–∫—Ü–∏–∏:", error));
            }
        }
        
        // –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –ø–æ—Å—Ç–∞
        function boostPost(postId) {
            if (!currentUser || !firebase.apps.length) return;
            
            if (userBoosts[postId]) {
                showToast("–í—ã —É–∂–µ –ø—Ä–æ–¥–≤–∏–≥–∞–ª–∏ —ç—Ç–æ—Ç –ø–æ—Å—Ç!");
                return;
            }
            
            const db = firebase.database();
            const postRef = db.ref('posts/' + postId);
            const userBoostRef = db.ref('user_boosts/' + currentUser.id + '/' + postId);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –±—É—Å—Ç
            postRef.child('boosts').once('value')
                .then(snapshot => {
                    const currentBoosts = snapshot.val() || 0;
                    return postRef.child('boosts').set(currentBoosts + 1);
                })
                .then(() => userBoostRef.set(true))
                .then(() => {
                    userBoosts[postId] = true;
                    showToast("üî• –ü–æ—Å—Ç –ø—Ä–æ–¥–≤–∏–Ω—É—Ç!");
                    loadPosts();
                })
                .catch(error => console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è –ø–æ—Å—Ç–∞:", error));
        }
        
        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞
        function setFilter(filter) {
            currentFilter = filter;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderPosts();
        }
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    showToast("–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–µ–Ω—å—à–µ 5MB");
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    selectedImage = event.target.result;
                    showImagePreview(selectedImage);
                    updateSendButton();
                };
                reader.readAsDataURL(file);
            }
        });
        
        function showImagePreview(dataUrl) {
            const previewDiv = document.getElementById('imagePreview');
            previewDiv.innerHTML = `
                <img class="preview-image" src="${dataUrl}" alt="Preview">
                <button class="remove-preview" onclick="removeImagePreview()">√ó</button>
            `;
        }
        
        function removeImagePreview() {
            const previewDiv = document.getElementById('imagePreview');
            previewDiv.innerHTML = '';
            selectedImage = null;
            document.getElementById('fileInput').value = '';
            updateSendButton();
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
        function updateSendButton() {
            const text = document.getElementById('postInput').value.trim();
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = text.length === 0 && !selectedImage;
        }
        
        // –û—Ç–∫—Ä—ã—Ç–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function openUserProfile(userId) {
            if (userId === 'anonymous' || userId.startsWith('anonymous_')) {
                showToast("–≠—Ç–æ –∞–Ω–æ–Ω–∏–º–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å");
                return;
            }
            
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å Telegram
            showToast("–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è");
        }
        
        function openTelegramProfile() {
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                showToast("–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å Telegram");
            }
        }
        
        function openImage(imageUrl) {
            if (tg && tg.openLink) {
                tg.openLink(imageUrl);
            } else {
                window.open(imageUrl, '_blank');
            }
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ Firebase
            setTimeout(() => {
                initUser();
                loadPosts();
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
                setInterval(loadPosts, 10000);
            }, 1000);
        });
        
        // –°–ª–µ–¥–∏–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Ç–µ–∫—Å—Ç–∞
        document.getElementById('postInput').addEventListener('input', updateSendButton);
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏–∑ HTML
        window.sendPost = sendPost;
        window.setFilter = setFilter;
        window.addReaction = addReaction;
        window.boostPost = boostPost;
        window.openUserProfile = openUserProfile;
        window.openTelegramProfile = openTelegramProfile;
        window.openImage = openImage;
        window.removeImagePreview = removeImagePreview;
    </script>
</body>
</html>
