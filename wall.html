<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ç–µ–Ω–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- –°—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏ Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 16px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            background: var(--tg-theme-bg-color, #ffffff);
            z-index: 100;
            border-bottom: 1px solid var(--tg-theme-hint-color, #cccccc);
        }

        .header-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--tg-theme-text-color, #000000);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .notification-btn {
            position: relative;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--tg-theme-text-color, #000000);
            padding: 4px;
        }

        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: #ff3333;
            color: white;
            font-size: 12px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid var(--tg-theme-button-color, #2481cc);
        }

        .input-section {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .post-input {
            width: 100%;
            min-height: 60px;
            padding: 12px;
            border: none;
            border-radius: 12px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            font-size: 16px;
            resize: none;
            margin-bottom: 12px;
        }

        .post-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--tg-theme-button-color, #2481cc);
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }

        #fileInput {
            display: none;
        }

        .hashtag-hint {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #666666);
            margin-top: 4px;
        }

        .send-button {
            padding: 8px 24px;
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .filters-container {
            position: relative;
            margin-bottom: 20px;
        }

        .filters-wrapper {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 12px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .filters-wrapper::-webkit-scrollbar {
            display: none;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid var(--tg-theme-button-color, #2481cc);
            border-radius: 20px;
            background: transparent;
            color: var(--tg-theme-button-color, #2481cc);
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .filter-btn.active {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .filter-btn.hashtag {
            background: rgba(36, 129, 204, 0.1);
            border-color: rgba(36, 129, 204, 0.3);
        }

        .posts-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding-bottom: 80px;
        }

        .post {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 16px;
            padding: 16px;
            position: relative;
            animation: fadeIn 0.3s ease;
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .post-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
        }

        .post-user-info {
            flex: 1;
        }

        .post-username {
            font-weight: 600;
            color: var(--tg-theme-text-color, #000000);
            cursor: pointer;
            margin-bottom: 2px;
            display: inline-block;
        }

        .post-username:hover {
            text-decoration: underline;
        }

        .post-time {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #666666);
        }

        .post-boost-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: linear-gradient(45deg, #ff6b00, #ff9500);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            z-index: 10;
        }

        .post-boost-btn.boosted {
            background: linear-gradient(45deg, #00c6ff, #0072ff);
        }

        .post-content {
            margin-bottom: 12px;
            line-height: 1.5;
            color: var(--tg-theme-text-color, #000000);
            word-break: break-word;
        }

        .hashtag {
            color: var(--tg-theme-button-color, #2481cc);
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
        }

        .mention {
            color: var(--tg-theme-button-color, #2481cc);
            font-weight: 500;
            text-decoration: none;
        }

        .post-image {
            width: 100%;
            border-radius: 12px;
            margin-bottom: 12px;
            max-height: 400px;
            object-fit: cover;
        }

        .post-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        .post-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .reaction-btn {
            padding: 4px 12px;
            border: 1px solid var(--tg-theme-hint-color, #cccccc);
            border-radius: 16px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
        }

        .reaction-btn:hover {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
        }

        .reaction-count {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #666666);
            margin-left: 4px;
        }

        .reaction-picker-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
        }

        .reaction-picker {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 20px 20px 0 0;
            padding: 20px;
            z-index: 1001;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .reaction-picker.active {
            transform: translateY(0);
        }

        .reaction-picker-title {
            text-align: center;
            margin-bottom: 16px;
            font-weight: 600;
            color: var(--tg-theme-text-color, #000000);
        }

        .reactions-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
        }

        .reaction-emoji {
            font-size: 28px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 12px;
            transition: background-color 0.2s;
        }

        .reaction-emoji:hover {
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
        }

        .comment-btn {
            padding: 4px 12px;
            border: 1px solid var(--tg-theme-hint-color, #cccccc);
            border-radius: 16px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
        }

        .comment-btn:hover {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
        }

        .comments-count {
            color: var(--tg-theme-hint-color, #666666);
            font-size: 14px;
            margin-left: 4px;
        }

        .hot-badge {
            display: inline-block;
            padding: 2px 8px;
            background: linear-gradient(45deg, #ff3366, #ff6633);
            color: white;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 8px;
        }

        .boost-count {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #666666);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--tg-theme-hint-color, #666666);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--tg-theme-hint-color, #666666);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ */
        .comments-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
        }

        .comments-panel {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            height: 70vh;
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 20px 20px 0 0;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .comments-panel.active {
            transform: translateY(0);
        }

        .comments-header {
            padding: 16px;
            border-bottom: 1px solid var(--tg-theme-hint-color, #cccccc);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comments-title {
            font-weight: 600;
            font-size: 18px;
        }

        .close-comments {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--tg-theme-text-color, #000000);
        }

        .comments-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .comment-item {
            padding: 12px 0;
            border-bottom: 1px solid var(--tg-theme-secondary-bg-color, #f0f0f0);
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .comment-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
        }

        .comment-username {
            font-weight: 600;
            font-size: 14px;
            color: var(--tg-theme-text-color, #000000);
            cursor: pointer;
        }

        .comment-time {
            font-size: 11px;
            color: var(--tg-theme-hint-color, #666666);
            margin-left: auto;
        }

        .comment-content {
            font-size: 14px;
            line-height: 1.4;
            color: var(--tg-theme-text-color, #000000);
            margin-bottom: 8px;
        }

        .comment-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .comment-like-btn {
            background: none;
            border: none;
            color: var(--tg-theme-hint-color, #666666);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .comment-like-btn.liked {
            color: var(--tg-theme-button-color, #2481cc);
        }

        .comment-reply-btn {
            background: none;
            border: none;
            color: var(--tg-theme-button-color, #2481cc);
            font-size: 12px;
            cursor: pointer;
        }

        .comment-input-container {
            padding: 16px;
            border-top: 1px solid var(--tg-theme-hint-color, #cccccc);
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
        }

        .comment-input-wrapper {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        .comment-input {
            flex: 1;
            min-height: 40px;
            max-height: 120px;
            padding: 8px 12px;
            border: 1px solid var(--tg-theme-hint-color, #cccccc);
            border-radius: 20px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            font-size: 14px;
            resize: none;
        }

        .comment-input:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #2481cc);
        }

        .send-comment-btn {
            padding: 8px 16px;
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }

        .send-comment-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notifications-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 300px;
            height: 100vh;
            background: var(--tg-theme-bg-color, #ffffff);
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            z-index: 1002;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .notifications-panel.active {
            transform: translateX(0);
        }

        .notifications-header {
            padding: 16px;
            border-bottom: 1px solid var(--tg-theme-hint-color, #cccccc);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notifications-title {
            font-weight: 600;
            font-size: 18px;
        }

        .close-notifications {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--tg-theme-text-color, #000000);
        }

        .notifications-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .notification-item {
            padding: 12px;
            border-bottom: 1px solid var(--tg-theme-secondary-bg-color, #f0f0f0);
            cursor: pointer;
        }

        .notification-item.unread {
            background: rgba(36, 129, 204, 0.05);
        }

        .notification-text {
            font-size: 14px;
            line-height: 1.4;
            color: var(--tg-theme-text-color, #000000);
            margin-bottom: 4px;
        }

        .notification-time {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #666666);
        }

        /* Welcome Modal */
        .welcome-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .welcome-modal {
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 20px;
            padding: 24px;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .welcome-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--tg-theme-text-color, #000000);
            text-align: center;
        }

        .welcome-section {
            margin-bottom: 20px;
        }

        .welcome-section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--tg-theme-text-color, #000000);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .welcome-text {
            font-size: 14px;
            line-height: 1.5;
            color: var(--tg-theme-text-color, #000000);
            margin-bottom: 12px;
        }

        .welcome-emoji {
            font-size: 20px;
        }

        .welcome-close-btn {
            width: 100%;
            padding: 12px;
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
        }

        .image-preview {
            position: relative;
            margin-bottom: 12px;
        }

        .preview-image {
            width: 100%;
            border-radius: 12px;
            max-height: 200px;
            object-fit: cover;
        }

        .remove-preview {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--tg-theme-secondary-bg-color, #333);
            color: var(--tg-theme-text-color, #fff);
            padding: 12px 24px;
            border-radius: 20px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="header-title">–°—Ç–µ–Ω–∞</h1>
            <div class="header-controls">
                <button class="notification-btn" onclick="toggleNotifications()">
                    üîî
                    <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
                </button>
                <img id="userAvatar" class="user-avatar" src="" alt="Avatar" onclick="openTelegramProfile()">
            </div>
        </div>

        <div class="input-section">
            <textarea class="post-input" id="postInput" placeholder="–ß—Ç–æ —É –≤–∞—Å –Ω–æ–≤–æ–≥–æ? –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ #—Ö–µ—à—Ç–µ–≥–∏ –∏ @—É–ø–æ–º–∏–Ω–∞–Ω–∏—è..." maxlength="500"></textarea>
            <div class="hashtag-hint">–ü—Ä–∏–º–µ—Ä: #–Ω–æ–≤–æ—Å—Ç–∏ #—é–º–æ—Ä #–∏–¥–µ—è @username</div>
            
            <div id="imagePreview" class="image-preview"></div>
            
            <div class="controls">
                <label class="file-input-label">
                    üì∑ –§–æ—Ç–æ
                    <input type="file" id="fileInput" accept="image/*">
                </label>
                
                <button class="send-button" id="sendBtn" onclick="sendPost()" disabled>–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </div>
        </div>

        <div class="filters-container">
            <div class="filters-wrapper" id="filtersWrapper">
                <button class="filter-btn active" onclick="setFilter('boosted')">üî• –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ</button>
                <button class="filter-btn" onclick="setFilter('all')">üîÑ –í—Å–µ</button>
                <!-- –•–µ—à—Ç–µ–≥–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>

        <div class="posts-container" id="postsContainer">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...</div>
        </div>

        <!-- –ü–∏–∫–µ—Ä —Ä–µ–∞–∫—Ü–∏–π -->
        <div class="reaction-picker-overlay" id="reactionPickerOverlay" onclick="closeReactionPicker()"></div>
        <div class="reaction-picker" id="reactionPicker">
            <div class="reaction-picker-title">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∞–∫—Ü–∏—é</div>
            <div class="reactions-grid" id="reactionsGrid">
                <!-- –†–µ–∞–∫—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>

        <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
        <div class="comments-overlay" id="commentsOverlay" onclick="closeComments()"></div>
        <div class="comments-panel" id="commentsPanel">
            <div class="comments-header">
                <div class="comments-title" id="commentsTitle">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</div>
                <button class="close-comments" onclick="closeComments()">√ó</button>
            </div>
            <div class="comments-list" id="commentsList">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤...</div>
            </div>
            <div class="comment-input-container">
                <div class="comment-input-wrapper">
                    <textarea class="comment-input" id="commentInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." maxlength="300"></textarea>
                    <button class="send-comment-btn" id="sendCommentBtn" onclick="sendComment()" disabled>‚û§</button>
                </div>
            </div>
        </div>

        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div class="notifications-panel" id="notificationsPanel">
            <div class="notifications-header">
                <div class="notifications-title">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                <button class="close-notifications" onclick="toggleNotifications()">√ó</button>
            </div>
            <div class="notifications-list" id="notificationsList">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π...</div>
            </div>
        </div>

        <!-- Welcome Modal -->
        <div class="welcome-modal-overlay" id="welcomeModal" style="display: none;">
            <div class="welcome-modal">
                <h2 class="welcome-title">üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ –°—Ç–µ–Ω—É!</h2>
                
                <div class="welcome-section">
                    <div class="welcome-section-title">üìù –ß—Ç–æ —ç—Ç–æ —Ç–∞–∫–æ–µ?</div>
                    <div class="welcome-text">
                        –≠—Ç–æ –º–µ—Å—Ç–æ, –≥–¥–µ –º–æ–∂–Ω–æ –¥–µ–ª–∏—Ç—å—Å—è –º—ã—Å–ª—è–º–∏, –∏–¥–µ—è–º–∏ –∏ –Ω–æ–≤–æ—Å—Ç—è–º–∏ —Å —Å–æ–æ–±—â–µ—Å—Ç–≤–æ–º. 
                        –ü—É–±–ª–∏–∫—É–π—Ç–µ –ø–æ—Å—Ç—ã, –∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–π—Ç–µ —Å –¥—Ä—É–≥–∏–º–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏.
                    </div>
                </div>
                
                <div class="welcome-section">
                    <div class="welcome-section-title">üî• –ß—Ç–æ —Ç–∞–∫–æ–µ –ë—É—Å—Ç—ã?</div>
                    <div class="welcome-text">
                        <span class="welcome-emoji">üî•</span> <strong>–ë—É—Å—Ç</strong> ‚Äî —ç—Ç–æ —Å–ø–æ—Å–æ–± –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –ø–æ—Å—Ç!<br><br>
                        ‚Ä¢ –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É <strong>"–ë—É—Å—Ç–Ω—É—Ç—å"</strong> üî• –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É –ø–æ—Å—Ç–∞<br>
                        ‚Ä¢ –ü–æ—Å—Ç –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ "–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ"<br>
                        ‚Ä¢ –ü–æ—Å—Ç—ã —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –±—É—Å—Ç–æ–≤ –ø–æ–ª—É—á–∞—é—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –æ—Ç–º–µ—Ç–∫—É<br>
                        ‚Ä¢ –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –±—É—Å—Ç–Ω—É—Ç—å –ø–æ—Å—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
                    </div>
                </div>
                
                <div class="welcome-section">
                    <div class="welcome-section-title">üí¨ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç?</div>
                    <div class="welcome-text">
                        <span class="welcome-emoji">üí¨</span> <strong>–†–µ–∞–∫—Ü–∏–∏</strong> ‚Äî –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É —Ä–µ–∞–∫—Ü–∏–∏ –ø–æ–¥ –ø–æ—Å—Ç–æ–º, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —ç–º–æ–¥–∑–∏<br>
                        <span class="welcome-emoji">#Ô∏è‚É£</span> <strong>–•–µ—à—Ç–µ–≥–∏</strong> ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ #–Ω–æ–≤–æ—Å—Ç–∏ #—é–º–æ—Ä #–∏–¥–µ—è –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏<br>
                        <span class="welcome-emoji">@</span> <strong>–£–ø–æ–º–∏–Ω–∞–Ω–∏—è</strong> ‚Äî —É–≤–µ–¥–æ–º–ª—è–π—Ç–µ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ @username<br>
                        <span class="welcome-emoji">üí¨</span> <strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</strong> ‚Äî –æ–±—Å—É–∂–¥–∞–π—Ç–µ –ø–æ—Å—Ç—ã –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö
                    </div>
                </div>
                
                <div class="welcome-section">
                    <div class="welcome-section-title">üèÜ –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –ø–æ—Å—Ç—ã</div>
                    <div class="welcome-text">
                        –í —Ä–∞–∑–¥–µ–ª–µ "–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ" –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –ø–æ—Å—Ç—ã —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –±—É—Å—Ç–æ–≤. 
                        –î–∞–∂–µ –Ω–æ–≤—ã–µ –ø–æ—Å—Ç—ã —Å 0 –±—É—Å—Ç–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∑–¥–µ—Å—å ‚Äî —É –Ω–∏—Ö –µ—Å—Ç—å —à–∞–Ω—Å —Å—Ç–∞—Ç—å –ø–æ–ø—É–ª—è—Ä–Ω—ã–º–∏!
                    </div>
                </div>
                
                <button class="welcome-close-btn" onclick="closeWelcomeModal()">–ü–æ–Ω—è—Ç–Ω–æ, –Ω–∞—á–∞—Ç—å!</button>
            </div>
        </div>

        <div class="toast" id="toast"></div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        const firebaseConfig = {
            databaseURL: "https://flum-2-default-rtdb.firebaseio.com/"
        };
        
        let app, database;
        if (typeof firebase !== 'undefined') {
            app = firebase.initializeApp(firebaseConfig);
            database = firebase.database(app);
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        let tg = window.Telegram?.WebApp || {
            initDataUnsafe: {
                user: {
                    id: Date.now(),
                    username: "test_user",
                    first_name: "–¢–µ—Å—Ç",
                    last_name: "",
                    photo_url: "https://i.pravatar.cc/150?img=3"
                }
            },
            expand: () => {},
            openLink: (url) => window.open(url, '_blank')
        };
        
        if (tg.expand) tg.expand();
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let currentUser = null;
        let posts = [];
        let currentFilter = 'boosted';
        let selectedImage = null;
        let userReactions = {};
        let userBoosts = {};
        let userCommentLikes = {};
        let currentPostForComments = null;
        let currentPostForReactions = null;
        let notifications = [];
        let unreadNotifications = 0;
        let popularHashtags = [];
        
        // –≠–º–æ–¥–∑–∏ –¥–ª—è —Ä–µ–∞–∫—Ü–∏–π
        const reactionEmojis = [
            'üëç', '‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢', 'üò°', 'üéâ', 'üëè', 'üî•', '‚≠ê',
            'üíØ', 'üëÄ', 'ü§î', 'ü§Ø', 'ü•≥', 'üòç', 'ü§Æ', 'üëé', 'üôè', '‚úåÔ∏è'
        ];
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º welcome –º–æ–¥–∞–ª–∫—É –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ
        function checkFirstVisit() {
            const hasVisited = localStorage.getItem('wall_visited');
            if (!hasVisited) {
                setTimeout(() => {
                    document.getElementById('welcomeModal').style.display = 'flex';
                }, 1000);
            }
        }
        
        function closeWelcomeModal() {
            document.getElementById('welcomeModal').style.display = 'none';
            localStorage.setItem('wall_visited', 'true');
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function initUser() {
            const tgUser = tg.initDataUnsafe?.user;
            currentUser = {
                id: tgUser?.id?.toString() || 'anonymous_' + Date.now(),
                username: tgUser?.username || 'user_' + Math.random().toString(36).substr(2, 9),
                firstName: tgUser?.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                lastName: tgUser?.last_name || '',
                photoUrl: tgUser?.photo_url || 'https://i.pravatar.cc/150?img=3'
            };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑—É
            if (database && currentUser.id && !currentUser.id.includes('anonymous')) {
                database.ref('users/' + currentUser.id).set({
                    username: currentUser.username,
                    photoUrl: currentUser.photoUrl,
                    firstName: currentUser.firstName,
                    lastName: currentUser.lastName,
                    lastSeen: Date.now()
                });
            }
            
            document.getElementById('userAvatar').src = currentUser.photoUrl;
            loadUserData();
            checkFirstVisit();
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function loadUserData() {
            if (!database) return;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∞–∫—Ü–∏–∏
            database.ref('user_reactions/' + currentUser.id).once('value')
                .then(snapshot => {
                    userReactions = snapshot.val() || {};
                });
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –±—É—Å—Ç—ã
            database.ref('user_boosts/' + currentUser.id).once('value')
                .then(snapshot => {
                    userBoosts = snapshot.val() || {};
                });
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–∞–π–∫–∏ –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
            database.ref('user_comment_likes/' + currentUser.id).once('value')
                .then(snapshot => {
                    userCommentLikes = snapshot.val() || {};
                });
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            loadNotifications();
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function loadNotifications() {
            if (!database) return;
            
            database.ref('notifications/' + currentUser.id).orderByChild('timestamp').limitToLast(50).once('value')
                .then(snapshot => {
                    const data = snapshot.val();
                    notifications = data ? Object.entries(data).map(([id, notif]) => ({ id, ...notif })) : [];
                    notifications.sort((a, b) => b.timestamp - a.timestamp);
                    
                    unreadNotifications = notifications.filter(n => !n.read).length;
                    updateNotificationBadge();
                    renderNotifications();
                });
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–π–¥–∂–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            if (unreadNotifications > 0) {
                badge.textContent = unreadNotifications > 99 ? '99+' : unreadNotifications;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function sendNotification(userId, type, data) {
            if (!database || userId === currentUser.id) return;
            
            const notificationRef = database.ref('notifications/' + userId).push();
            notificationRef.set({
                type: type,
                data: data,
                timestamp: Date.now(),
                read: false,
                fromUserId: currentUser.id,
                fromUsername: currentUser.username
            });
        }
        
        // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è Data URL –≤ ImgBB —Å—Å—ã–ª–∫—É
        async function convertDataUrlToImgBB(dataUrl) {
            try {
                const apiKey = "02cf7a0dc37b8a8adaedc9784752a3db";
                const base64Data = dataUrl.split(',')[1];
                if (!base64Data) return null;
                
                const formData = new FormData();
                formData.append('key', apiKey);
                formData.append('image', base64Data);
                
                const response = await fetch("https://api.imgbb.com/1/upload", {
                    method: "POST",
                    body: formData
                });
                
                const data = await response.json();
                return data.success ? data.data.url : null;
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:", error);
                return null;
            }
        }
        
        // –ü–æ–∏—Å–∫ —Ö–µ—à—Ç–µ–≥–æ–≤ –≤ —Ç–µ–∫—Å—Ç–µ
        function findHashtags(text) {
            const hashtagRegex = /#([\w\u0400-\u04FF]+)/g;
            const hashtags = [];
            let match;
            while ((match = hashtagRegex.exec(text)) !== null) {
                hashtags.push(match[1].toLowerCase());
            }
            return [...new Set(hashtags)];
        }
        
        // –ü–æ–∏—Å–∫ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π –≤ —Ç–µ–∫—Å—Ç–µ
        function findMentions(text) {
            const mentionRegex = /@(\w+)/g;
            const mentions = [];
            let match;
            while ((match = mentionRegex.exec(text)) !== null) {
                mentions.push(match[1]);
            }
            return [...new Set(mentions)];
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ö–µ—à—Ç–µ–≥–æ–≤
        function loadPopularHashtags() {
            if (!database) return;
            
            database.ref('hashtags').orderByChild('count').limitToLast(5).once('value')
                .then(snapshot => {
                    const data = snapshot.val();
                    popularHashtags = data ? Object.entries(data).map(([hashtag, info]) => ({ 
                        hashtag, 
                        count: info.count || 0 
                    })) : [];
                    
                    popularHashtags.sort((a, b) => b.count - a.count);
                    renderHashtagFilters();
                });
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ —Ö–µ—à—Ç–µ–≥–æ–≤
        function updateHashtagCounts(hashtags) {
            if (!database) return;
            
            hashtags.forEach(hashtag => {
                const hashtagRef = database.ref('hashtags/' + hashtag);
                hashtagRef.transaction(current => {
                    if (current) {
                        return { ...current, count: (current.count || 0) + 1 };
                    }
                    return { count: 1, lastUsed: Date.now() };
                });
            });
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ—Å—Ç–∞
        async function sendPost() {
            const text = document.getElementById('postInput').value.trim();
            
            if (!text && !selectedImage) {
                showToast("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ");
                return;
            }
            
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = "–ü—É–±–ª–∏–∫–∞—Ü–∏—è...";
            
            let imageUrl = null;
            if (selectedImage) {
                imageUrl = await convertDataUrlToImgBB(selectedImage);
                if (!imageUrl) {
                    showToast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ");
                    sendBtn.disabled = false;
                    sendBtn.textContent = "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å";
                    return;
                }
            }
            
            // –ò—â–µ–º —Ö–µ—à—Ç–µ–≥–∏ –∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è
            const hashtags = findHashtags(text);
            const mentions = findMentions(text);
            
            const postData = {
                userId: currentUser.id,
                username: currentUser.username || currentUser.firstName,
                userPhoto: currentUser.photoUrl,
                text: text,
                imageUrl: imageUrl,
                timestamp: Date.now(),
                boosts: 0,
                boostedUsers: {},
                commentsCount: 0,
                hashtags: hashtags,
                mentions: mentions,
                reactions: {}
            };
            
            try {
                const newPostRef = database.ref('posts').push();
                await newPostRef.set(postData);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ —Ö–µ—à—Ç–µ–≥–æ–≤
                updateHashtagCounts(hashtags);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± —É–ø–æ–º–∏–Ω–∞–Ω–∏—è—Ö
                mentions.forEach(mention => {
                    database.ref('users').orderByChild('username').equalTo(mention).once('value')
                        .then(snapshot => {
                            const userData = snapshot.val();
                            if (userData) {
                                const userId = Object.keys(userData)[0];
                                sendNotification(userId, 'mention', {
                                    postId: newPostRef.key,
                                    text: text.substring(0, 100) + '...'
                                });
                            }
                        });
                });
                
                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                document.getElementById('postInput').value = '';
                removeImagePreview();
                selectedImage = null;
                updateSendButton();
                
                showToast("‚úÖ –ü–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!");
                loadPosts();
                loadPopularHashtags();
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ—Å—Ç–∞:", error);
                showToast("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏");
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å";
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤
        function loadPosts() {
            if (!database) return;
            
            const postsContainer = document.getElementById('postsContainer');
            postsContainer.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...</div>';
            
            database.ref('posts').once('value')
                .then(snapshot => {
                    const postsData = snapshot.val();
                    
                    if (!postsData) {
                        postsContainer.innerHTML = '<div class="empty-state">–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>';
                        posts = [];
                        return;
                    }
                    
                    posts = Object.entries(postsData).map(([id, post]) => ({
                        id,
                        ...post
                    }));
                    
                    renderPosts();
                })
                .catch(error => {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤:", error);
                    postsContainer.innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                });
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Å—Ç–æ–≤
        function renderPosts() {
            const postsContainer = document.getElementById('postsContainer');
            const filteredPosts = filterPosts();
            
            if (filteredPosts.length === 0) {
                postsContainer.innerHTML = '<div class="empty-state">–ù–µ—Ç –ø–æ—Å—Ç–æ–≤</div>';
                return;
            }
            
            postsContainer.innerHTML = '';
            filteredPosts.forEach(post => {
                postsContainer.appendChild(createPostElement(post));
            });
        }
        
        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–æ–≤
        function filterPosts() {
            let filtered = [...posts];
            
            if (currentFilter === 'boosted') {
                // –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –±—É—Å—Ç–∞–º, –ø–æ—Ç–æ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                filtered.sort((a, b) => {
                    if (b.boosts !== a.boosts) {
                        return b.boosts - a.boosts;
                    }
                    return b.timestamp - a.timestamp;
                });
            } else if (currentFilter === 'all') {
                filtered.sort((a, b) => b.timestamp - a.timestamp);
            } else if (currentFilter.startsWith('#')) {
                const hashtag = currentFilter.substring(1);
                filtered = filtered.filter(post => 
                    post.hashtags && post.hashtags.includes(hashtag)
                ).sort((a, b) => b.timestamp - a.timestamp);
            }
            
            return filtered;
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–æ—Å—Ç–∞
        function createPostElement(post) {
            const postDiv = document.createElement('div');
            postDiv.className = 'post';
            
            const isHot = post.boosts >= 3;
            const time = new Date(post.timestamp).toLocaleString('ru-RU', {
                day: 'numeric',
                month: 'short',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const hasBoosted = userBoosts[post.id];
            const userReaction = userReactions[post.id];
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç —Å —Ö–µ—à—Ç–µ–≥–∞–º–∏ –∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è–º–∏
            let processedText = escapeHtml(post.text || '');
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ö–µ—à—Ç–µ–≥–∏
            if (post.hashtags) {
                post.hashtags.forEach(hashtag => {
                    const regex = new RegExp(`#${hashtag}`, 'gi');
                    processedText = processedText.replace(regex, 
                        `<span class="hashtag" onclick="setFilter('#${hashtag}')">#${hashtag}</span>`);
                });
            }
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏—è
            if (post.mentions) {
                post.mentions.forEach(mention => {
                    const regex = new RegExp(`@${mention}`, 'gi');
                    processedText = processedText.replace(regex, 
                        `<a href="https://t.me/${mention}" class="mention" target="_blank">@${mention}</a>`);
                });
            }
            
            // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∞–∫—Ü–∏–π
            const totalReactions = post.reactions ? Object.values(post.reactions).reduce((a, b) => a + b, 0) : 0;
            
            postDiv.innerHTML = `
                <div class="post-header">
                    <img class="post-avatar" src="${post.userPhoto || 'https://i.pravatar.cc/150?img=0'}" 
                         alt="${post.username}" 
                         onclick="openUserProfile('${post.userId}')">
                    <div class="post-user-info">
                        <div>
                            <span class="post-username" onclick="openUserProfile('${post.userId}')">
                                ${post.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}
                                ${isHot ? '<span class="hot-badge">üî• –ì–û–†–Ø–ß–ò–ô</span>' : ''}
                            </span>
                            <span class="post-time">${time}</span>
                        </div>
                    </div>
                </div>
                
                <button class="post-boost-btn ${hasBoosted ? 'boosted' : ''}" 
                        onclick="boostPost('${post.id}')" title="–ë—É—Å—Ç–Ω—É—Ç—å –ø–æ—Å—Ç">
                    üî• ${post.boosts || 0}
                </button>
                
                ${processedText ? `<div class="post-content">${processedText}</div>` : ''}
                
                ${post.imageUrl ? `<img class="post-image" src="${post.imageUrl}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">` : ''}
                
                <div class="post-stats">
                    <div class="post-actions">
                        <button class="reaction-btn" onclick="openReactionPicker('${post.id}')">
                            ${userReaction ? userReaction : 'üëç'} –†–µ–∞–∫—Ü–∏—è
                            ${totalReactions > 0 ? `<span class="reaction-count">${totalReactions}</span>` : ''}
                        </button>
                        <button class="comment-btn" onclick="openComments('${post.id}')">
                            üí¨ –ö–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å
                            <span class="comments-count">(${post.commentsCount || 0})</span>
                        </button>
                    </div>
                    <div class="boost-count">
                        üî• ${post.boosts || 0} –±—É—Å—Ç–æ–≤
                    </div>
                </div>
            `;
            
            return postDiv;
        }
        
        // –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–∏–∫–µ—Ä–∞ —Ä–µ–∞–∫—Ü–∏–π
        function openReactionPicker(postId) {
            currentPostForReactions = postId;
            const overlay = document.getElementById('reactionPickerOverlay');
            const picker = document.getElementById('reactionPicker');
            const grid = document.getElementById('reactionsGrid');
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ—Ç–∫—É —ç–º–æ–¥–∑–∏
            grid.innerHTML = '';
            reactionEmojis.forEach(emoji => {
                const button = document.createElement('button');
                button.className = 'reaction-emoji';
                button.textContent = emoji;
                button.onclick = () => addReaction(postId, emoji);
                grid.appendChild(button);
            });
            
            overlay.style.display = 'block';
            picker.classList.add('active');
        }
        
        function closeReactionPicker() {
            const overlay = document.getElementById('reactionPickerOverlay');
            const picker = document.getElementById('reactionPicker');
            overlay.style.display = 'none';
            picker.classList.remove('active');
            currentPostForReactions = null;
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∞–∫—Ü–∏–∏
        function addReaction(postId, emoji) {
            if (!database) return;
            
            const postRef = database.ref('posts/' + postId + '/reactions/' + emoji);
            const userReactionRef = database.ref('user_reactions/' + currentUser.id + '/' + postId);
            
            const userReaction = userReactions[postId];
            
            if (userReaction === emoji) {
                // –£–¥–∞–ª—è–µ–º —Ä–µ–∞–∫—Ü–∏—é
                postRef.transaction(current => (current || 1) - 1);
                userReactionRef.remove();
                delete userReactions[postId];
            } else {
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Ä–µ–∞–∫—Ü–∏—é
                if (userReaction) {
                    database.ref('posts/' + postId + '/reactions/' + userReaction)
                        .transaction(current => (current || 1) - 1);
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é
                postRef.transaction(current => (current || 0) + 1);
                userReactionRef.set(emoji);
                userReactions[postId] = emoji;
                
                // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–∞–∫—Ü–∏–∏
                database.ref('posts/' + postId).once('value')
                    .then(snapshot => {
                        const post = snapshot.val();
                        if (post && post.userId !== currentUser.id) {
                            sendNotification(post.userId, 'reaction', {
                                postId: postId,
                                emoji: emoji,
                                reactor: currentUser.username
                            });
                        }
                    });
            }
            
            closeReactionPicker();
            loadPosts();
        }
        
        // –ë—É—Å—Ç –ø–æ—Å—Ç–∞
        function boostPost(postId) {
            if (!database) return;
            
            if (userBoosts[postId]) {
                showToast("–í—ã —É–∂–µ –±—É—Å—Ç–Ω—É–ª–∏ —ç—Ç–æ—Ç –ø–æ—Å—Ç!");
                return;
            }
            
            const postRef = database.ref('posts/' + postId + '/boosts');
            const userBoostRef = database.ref('user_boosts/' + currentUser.id + '/' + postId);
            
            postRef.transaction(current => (current || 0) + 1);
            userBoostRef.set(true);
            userBoosts[postId] = true;
            
            showToast("üî• –ü–æ—Å—Ç –±—É—Å—Ç–Ω—É—Ç!");
            loadPosts();
        }
        
        // –û—Ç–∫—Ä—ã—Ç–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
        function openUserProfile(userId) {
            database.ref('users/' + userId).once('value')
                .then(snapshot => {
                    const user = snapshot.val();
                    if (user && user.username) {
                        tg.openLink(`https://t.me/${user.username}`);
                    } else {
                        showToast("–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");
                    }
                })
                .catch(() => {
                    showToast("–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");
                });
        }
        
        function openTelegramProfile() {
            if (currentUser.username) {
                tg.openLink(`https://t.me/${currentUser.username}`);
            } else {
                showToast("–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");
            }
        }
        
        // –†–∞–±–æ—Ç–∞ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏
        let currentComments = [];
        
        function openComments(postId) {
            currentPostForComments = postId;
            const panel = document.getElementById('commentsPanel');
            const overlay = document.getElementById('commentsOverlay');
            const title = document.getElementById('commentsTitle');
            
            panel.classList.add('active');
            overlay.style.display = 'block';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
            loadComments(postId);
        }
        
        function closeComments() {
            const panel = document.getElementById('commentsPanel');
            const overlay = document.getElementById('commentsOverlay');
            panel.classList.remove('active');
            overlay.style.display = 'none';
            currentPostForComments = null;
        }
        
        function loadComments(postId) {
            if (!database) return;
            
            const commentsList = document.getElementById('commentsList');
            commentsList.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤...</div>';
            
            database.ref('comments/' + postId).orderByChild('timestamp').once('value')
                .then(snapshot => {
                    const data = snapshot.val();
                    currentComments = data ? Object.entries(data).map(([id, comment]) => ({ id, ...comment })) : [];
                    currentComments.sort((a, b) => a.timestamp - b.timestamp);
                    renderComments();
                });
        }
        
        function renderComments() {
            const commentsList = document.getElementById('commentsList');
            
            if (currentComments.length === 0) {
                commentsList.innerHTML = '<div class="empty-state">–ù–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</div>';
                return;
            }
            
            commentsList.innerHTML = '';
            currentComments.forEach(comment => {
                commentsList.appendChild(createCommentElement(comment));
            });
        }
        
        function createCommentElement(comment) {
            const div = document.createElement('div');
            div.className = 'comment-item';
            
            const time = new Date(comment.timestamp).toLocaleString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const isLiked = userCommentLikes[comment.id];
            const likes = comment.likes || 0;
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏—è
            let processedText = escapeHtml(comment.text || '');
            const mentions = findMentions(comment.text);
            mentions.forEach(mention => {
                const regex = new RegExp(`@${mention}`, 'g');
                processedText = processedText.replace(regex, 
                    `<a href="https://t.me/${mention}" class="mention" target="_blank">@${mention}</a>`);
            });
            
            div.innerHTML = `
                <div class="comment-header">
                    <img class="comment-avatar" src="${comment.userPhoto || 'https://i.pravatar.cc/150?img=0'}" 
                         alt="${comment.username}">
                    <span class="comment-username" onclick="openCommentUserProfile('${comment.userId}')">
                        ${comment.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}
                    </span>
                    <span class="comment-time">${time}</span>
                </div>
                <div class="comment-content">${processedText}</div>
                <div class="comment-actions">
                    <button class="comment-like-btn ${isLiked ? 'liked' : ''}" 
                            onclick="likeComment('${comment.id}')">
                        üëç ${likes}
                    </button>
                    <button class="comment-reply-btn" onclick="replyToComment('${comment.username}')">
                        –û—Ç–≤–µ—Ç–∏—Ç—å
                    </button>
                </div>
            `;
            
            return div;
        }
        
        function sendComment() {
            const text = document.getElementById('commentInput').value.trim();
            if (!text || !currentPostForComments || !database) return;
            
            const commentRef = database.ref('comments/' + currentPostForComments).push();
            const comment = {
                userId: currentUser.id,
                username: currentUser.username || currentUser.firstName,
                userPhoto: currentUser.photoUrl,
                text: text,
                timestamp: Date.now(),
                likes: 0,
                mentions: findMentions(text)
            };
            
            commentRef.set(comment).then(() => {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
                database.ref('posts/' + currentPostForComments + '/commentsCount')
                    .transaction(current => (current || 0) + 1);
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                document.getElementById('commentInput').value = '';
                document.getElementById('sendCommentBtn').disabled = true;
                
                // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü—É –ø–æ—Å—Ç–∞
                database.ref('posts/' + currentPostForComments).once('value')
                    .then(snapshot => {
                        const post = snapshot.val();
                        if (post && post.userId !== currentUser.id) {
                            sendNotification(post.userId, 'comment', {
                                postId: currentPostForComments,
                                commenter: currentUser.username,
                                text: text.substring(0, 50) + '...'
                            });
                        }
                    });
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                loadComments(currentPostForComments);
                loadPosts();
            });
        }
        
        function likeComment(commentId) {
            if (!database) return;
            
            const commentLikeRef = database.ref('user_comment_likes/' + currentUser.id + '/' + commentId);
            const commentLikesRef = database.ref('comments/' + currentPostForComments + '/' + commentId + '/likes');
            
            if (userCommentLikes[commentId]) {
                commentLikesRef.transaction(current => (current || 1) - 1);
                commentLikeRef.remove();
                delete userCommentLikes[commentId];
            } else {
                commentLikesRef.transaction(current => (current || 0) + 1);
                commentLikeRef.set(true);
                userCommentLikes[commentId] = true;
            }
            
            loadComments(currentPostForComments);
        }
        
        function replyToComment(username) {
            const input = document.getElementById('commentInput');
            input.value = `@${username} `;
            input.focus();
            updateCommentSendButton();
        }
        
        function openCommentUserProfile(userId) {
            openUserProfile(userId);
        }
        
        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function toggleNotifications() {
            const panel = document.getElementById('notificationsPanel');
            panel.classList.toggle('active');
            
            if (panel.classList.contains('active')) {
                markNotificationsAsRead();
            }
        }
        
        function renderNotifications() {
            const list = document.getElementById('notificationsList');
            
            if (notifications.length === 0) {
                list.innerHTML = '<div class="empty-state">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>';
                return;
            }
            
            list.innerHTML = '';
            notifications.forEach(notif => {
                const div = document.createElement('div');
                div.className = `notification-item ${notif.read ? '' : 'unread'}`;
                div.onclick = () => openNotification(notif);
                
                let text = '';
                const time = new Date(notif.timestamp).toLocaleString('ru-RU', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                switch (notif.type) {
                    case 'mention':
                        text = `${notif.fromUsername} —É–ø–æ–º—è–Ω—É–ª(–∞) –≤–∞—Å –≤ –ø–æ—Å—Ç–µ`;
                        break;
                    case 'reaction':
                        text = `${notif.fromUsername} –ø–æ—Å—Ç–∞–≤–∏–ª(–∞) —Ä–µ–∞–∫—Ü–∏—é ${notif.data?.emoji}`;
                        break;
                    case 'comment':
                        text = `${notif.fromUsername} –ø—Ä–æ–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–ª(–∞) –≤–∞—à –ø–æ—Å—Ç`;
                        break;
                    default:
                        text = '–ù–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ';
                }
                
                div.innerHTML = `
                    <div class="notification-text">${text}</div>
                    <div class="notification-time">${time}</div>
                `;
                
                list.appendChild(div);
            });
        }
        
        function markNotificationsAsRead() {
            if (!database || unreadNotifications === 0) return;
            
            const updates = {};
            notifications.forEach(notif => {
                if (!notif.read) {
                    updates[`notifications/${currentUser.id}/${notif.id}/read`] = true;
                }
            });
            
            database.ref().update(updates).then(() => {
                unreadNotifications = 0;
                updateNotificationBadge();
            });
        }
        
        function openNotification(notification) {
            if (notification.data?.postId) {
                closeComments();
                toggleNotifications();
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–æ—Å—Ç—É
                showToast("–ü–µ—Ä–µ—Ö–æ–¥ –∫ –ø–æ—Å—Ç—É...");
            }
        }
        
        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Ö–µ—à—Ç–µ–≥–æ–≤
        function renderHashtagFilters() {
            const wrapper = document.getElementById('filtersWrapper');
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ö–µ—à—Ç–µ–≥–∏
            const hashtagFilters = wrapper.querySelectorAll('.filter-btn.hashtag');
            hashtagFilters.forEach(btn => btn.remove());
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ö–µ—à—Ç–µ–≥–∏
            popularHashtags.forEach(({ hashtag, count }) => {
                const button = document.createElement('button');
                button.className = 'filter-btn hashtag';
                button.innerHTML = `#${hashtag}`;
                button.title = `${count} –ø–æ—Å—Ç–æ–≤`;
                button.onclick = () => setFilter('#' + hashtag);
                wrapper.appendChild(button);
            });
        }
        
        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞
        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É —Ñ–∏–ª—å—Ç—Ä–∞
            const buttons = document.querySelectorAll('.filter-btn');
            if (filter.startsWith('#')) {
                // –î–ª—è —Ö–µ—à—Ç–µ–≥–æ–≤ –∏—â–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–Ω–æ–ø–∫—É
                buttons.forEach(btn => {
                    if (btn.textContent === `#${filter.substring(1)}`) {
                        btn.classList.add('active');
                    }
                });
            } else {
                // –î–ª—è –æ–±—ã—á–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
                buttons.forEach(btn => {
                    if (btn.textContent.includes(filter === 'boosted' ? '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ' : '–í—Å–µ')) {
                        btn.classList.add('active');
                    }
                });
            }
            
            renderPosts();
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
        function updateSendButton() {
            const text = document.getElementById('postInput').value.trim();
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = text.length === 0 && !selectedImage;
        }
        
        function updateCommentSendButton() {
            const text = document.getElementById('commentInput').value.trim();
            document.getElementById('sendCommentBtn').disabled = text.length === 0;
        }
        
        // –†–∞–±–æ—Ç–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                if (file.size > 5 * 1024 * 1024) {
                    showToast("–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–µ–Ω—å—à–µ 5MB");
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    selectedImage = event.target.result;
                    showImagePreview(selectedImage);
                    updateSendButton();
                };
                reader.readAsDataURL(file);
            }
        });
        
        function showImagePreview(dataUrl) {
            const previewDiv = document.getElementById('imagePreview');
            previewDiv.innerHTML = `
                <img class="preview-image" src="${dataUrl}" alt="Preview">
                <button class="remove-preview" onclick="removeImagePreview()">√ó</button>
            `;
        }
        
        function removeImagePreview() {
            const previewDiv = document.getElementById('imagePreview');
            previewDiv.innerHTML = '';
            selectedImage = null;
            document.getElementById('fileInput').value = '';
            updateSendButton();
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            initUser();
            loadPosts();
            loadPopularHashtags();
            
            // –°–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π
            document.getElementById('postInput').addEventListener('input', updateSendButton);
            document.getElementById('commentInput').addEventListener('input', updateCommentSendButton);
            
            // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
            if (database) {
                database.ref('posts').on('value', () => {
                    loadPosts();
                    loadPopularHashtags();
                });
                database.ref('notifications/' + currentUser.id).on('value', () => {
                    loadNotifications();
                });
                database.ref('hashtags').on('value', () => {
                    loadPopularHashtags();
                });
            }
        });
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        window.sendPost = sendPost;
        window.setFilter = setFilter;
        window.openReactionPicker = openReactionPicker;
        window.closeReactionPicker = closeReactionPicker;
        window.addReaction = addReaction;
        window.boostPost = boostPost;
        window.openUserProfile = openUserProfile;
        window.openTelegramProfile = openTelegramProfile;
        window.removeImagePreview = removeImagePreview;
        window.openComments = openComments;
        window.closeComments = closeComments;
        window.sendComment = sendComment;
        window.likeComment = likeComment;
        window.replyToComment = replyToComment;
        window.toggleNotifications = toggleNotifications;
        window.updateSendButton = updateSendButton;
        window.closeWelcomeModal = closeWelcomeModal;
    </script>
</body>
</html>
