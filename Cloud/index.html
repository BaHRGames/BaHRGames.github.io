<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Store</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: 100px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            position: sticky;
            top: 0;
            background: var(--tg-theme-bg-color, #ffffff);
            z-index: 100;
            border-bottom: 1px solid var(--tg-theme-hint-color, #cccccc);
        }

        .header-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--tg-theme-text-color, #000000);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid var(--tg-theme-button-color, #2481cc);
        }

        .storage-info {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            padding: 16px;
            margin: 0 16px 16px;
            border-radius: 12px;
            text-align: center;
        }

        .storage-progress {
            height: 6px;
            background: var(--tg-theme-hint-color, #cccccc);
            border-radius: 3px;
            margin: 8px 0;
            overflow: hidden;
        }

        .storage-progress-fill {
            height: 100%;
            background: var(--tg-theme-button-color, #2481cc);
            width: 0%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .storage-text {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #666666);
        }

        .storage-text strong {
            color: var(--tg-theme-text-color, #000000);
        }

        /* Upload Button */
        .upload-btn-container {
            padding: 0 16px 16px;
        }

        .upload-btn {
            width: 100%;
            padding: 14px;
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            padding: 0 16px;
            border-bottom: 1px solid var(--tg-theme-hint-color, #cccccc);
            background: var(--tg-theme-bg-color, #ffffff);
            position: sticky;
            top: 60px;
            z-index: 90;
        }

        .tab {
            flex: 1;
            padding: 14px 0;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--tg-theme-hint-color, #666666);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
        }

        .tab.active {
            color: var(--tg-theme-button-color, #2481cc);
            border-bottom-color: var(--tg-theme-button-color, #2481cc);
        }

        /* Content */
        .content {
            padding: 16px;
        }

        /* Search */
        .search-container {
            margin-bottom: 20px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 14px 16px 14px 48px;
            border: 1px solid var(--tg-theme-hint-color, #cccccc);
            border-radius: 12px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000000);
            font-size: 16px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #2481cc);
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--tg-theme-hint-color, #666666);
        }

        /* Filters */
        .filters-wrapper {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 12px;
            margin-bottom: 16px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .filters-wrapper::-webkit-scrollbar {
            display: none;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid var(--tg-theme-hint-color, #cccccc);
            border-radius: 20px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000000);
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .filter-btn.active {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border-color: var(--tg-theme-button-color, #2481cc);
        }

        /* Files Grid */
        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .file-card {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .file-card:hover {
            transform: translateY(-2px);
        }

        .file-icon {
            width: 100%;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            background: linear-gradient(45deg, #2481cc, #4ca1ff);
            color: white;
        }

        .file-info {
            padding: 12px;
        }

        .file-name {
            font-weight: 600;
            color: var(--tg-theme-text-color, #000000);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 14px;
        }

        .file-meta {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #666666);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-size {
            white-space: nowrap;
        }

        /* Files List */
        .files-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .file-item {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        .file-item-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: var(--tg-theme-button-color, #2481cc);
            color: white;
        }

        .file-item-info {
            flex: 1;
            min-width: 0;
        }

        .file-item-name {
            font-weight: 500;
            color: var(--tg-theme-text-color, #000000);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-item-details {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #666666);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-item-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-action-btn {
            background: none;
            border: none;
            color: var(--tg-theme-hint-color, #666666);
            cursor: pointer;
            padding: 4px;
            font-size: 18px;
        }

        .file-action-btn:hover {
            color: var(--tg-theme-button-color, #2481cc);
        }

        /* Upload Panel */
        .upload-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 3000;
            display: none;
        }

        .upload-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80vh;
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 20px 20px 0 0;
            z-index: 3001;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .upload-panel.active {
            transform: translateY(0);
        }

        .upload-header {
            padding: 20px;
            border-bottom: 1px solid var(--tg-theme-hint-color, #cccccc);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .upload-title {
            font-weight: 600;
            font-size: 18px;
        }

        .close-upload {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--tg-theme-text-color, #000000);
        }

        .upload-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .upload-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 14px;
            color: var(--tg-theme-text-color, #000000);
            font-weight: 500;
        }

        .form-input {
            padding: 12px 16px;
            border: 1px solid var(--tg-theme-hint-color, #cccccc);
            border-radius: 12px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000000);
            font-size: 16px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #2481cc);
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 40px;
            border: 2px dashed var(--tg-theme-hint-color, #cccccc);
            border-radius: 16px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            cursor: pointer;
            text-align: center;
            flex-direction: column;
        }

        .file-input-label:hover {
            border-color: var(--tg-theme-button-color, #2481cc);
        }

        .file-input-text {
            font-size: 14px;
            color: var(--tg-theme-text-color, #000000);
        }

        .file-input-subtext {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #666666);
            margin-top: 4px;
        }

        #fileInput {
            display: none;
        }

        .file-info {
            margin-top: 8px;
            font-size: 14px;
            color: var(--tg-theme-hint-color, #666666);
        }

        .upload-footer {
            padding: 20px;
            border-top: 1px solid var(--tg-theme-hint-color, #cccccc);
        }

        .upload-button {
            width: 100%;
            padding: 16px;
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .upload-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* File Details Panel */
        .file-details-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 85vh;
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 20px 20px 0 0;
            z-index: 3001;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .file-details-panel.active {
            transform: translateY(0);
        }

        .file-details-header {
            padding: 20px;
            border-bottom: 1px solid var(--tg-theme-hint-color, #cccccc);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-details-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--tg-theme-text-color, #000000);
        }

        .file-details-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .file-preview {
            text-align: center;
            margin-bottom: 32px;
        }

        .file-preview-icon {
            width: 120px;
            height: 120px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 48px;
            background: linear-gradient(45deg, #2481cc, #4ca1ff);
            color: white;
        }

        .file-details-info {
            margin-bottom: 32px;
        }

        .file-details-name {
            font-size: 22px;
            font-weight: 700;
            color: var(--tg-theme-text-color, #000000);
            margin-bottom: 12px;
            word-break: break-all;
        }

        .file-details-meta {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            padding: 16px;
            border-radius: 12px;
        }

        .file-meta-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--tg-theme-hint-color, #cccccc);
        }

        .file-meta-item:last-child {
            border-bottom: none;
        }

        .file-meta-label {
            color: var(--tg-theme-hint-color, #666666);
            font-size: 14px;
        }

        .file-meta-value {
            color: var(--tg-theme-text-color, #000000);
            font-size: 14px;
            font-weight: 500;
        }

        .file-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .file-action-btn-large {
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .file-action-btn-large.primary {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .file-action-btn-large.secondary {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000000);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--tg-theme-secondary-bg-color, #333);
            color: var(--tg-theme-text-color, #fff);
            padding: 12px 24px;
            border-radius: 20px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 4000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            pointer-events: none;
            max-width: 90%;
            text-align: center;
        }

        .toast.show {
            opacity: 1;
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--tg-theme-text-color, #000000);
            margin-bottom: 8px;
        }

        .empty-text {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #666666);
            line-height: 1.5;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--tg-theme-hint-color, #666666);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1 class="header-title">Cloud Store</h1>
            <img id="userAvatar" class="user-avatar" src="" alt="Avatar" onclick="openTelegramProfile()">
        </div>

        <!-- Storage Info -->
        <div class="storage-info">
            <div class="storage-progress">
                <div class="storage-progress-fill" id="storageProgress"></div>
            </div>
            <div class="storage-text">
                –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: <strong id="storageUsed">0 MB</strong> –∏–∑ <strong id="storageTotal">1 GB</strong>
            </div>
        </div>

        <!-- Upload Button -->
        <div class="upload-btn-container">
            <button class="upload-btn" onclick="openUploadPanel()">
                üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
            </button>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('grid')">üìÅ</button>
            <button class="tab" onclick="switchTab('list')">üìã</button>
        </div>

        <!-- Content -->
        <div class="content" id="gridTab">
            <!-- Search -->
            <div class="search-container">
                <div class="search-icon">üîç</div>
                <input type="text" class="search-input" id="searchInput" placeholder="–ü–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤..." oninput="searchFiles()">
            </div>

            <!-- Filters -->
            <div class="filters-wrapper" id="filtersWrapper">
                <button class="filter-btn active" onclick="setFilter('all')">–í—Å–µ</button>
                <button class="filter-btn" onclick="setFilter('image')">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</button>
                <button class="filter-btn" onclick="setFilter('video')">–í–∏–¥–µ–æ</button>
                <button class="filter-btn" onclick="setFilter('audio')">–ê—É–¥–∏–æ</button>
                <button class="filter-btn" onclick="setFilter('document')">–î–æ–∫—É–º–µ–Ω—Ç—ã</button>
            </div>

            <!-- Files Grid -->
            <div class="files-grid" id="filesGrid">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤...</div>
            </div>
        </div>

        <div class="content" id="listTab" style="display: none;">
            <!-- Search -->
            <div class="search-container">
                <div class="search-icon">üîç</div>
                <input type="text" class="search-input" id="listSearchInput" placeholder="–ü–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤..." oninput="searchFilesList()">
            </div>

            <!-- Files List -->
            <div class="files-list" id="filesList">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤...</div>
            </div>
        </div>
    </div>

    <!-- Upload Panel -->
    <div class="upload-overlay" id="uploadOverlay" onclick="closeUploadPanel()"></div>
    <div class="upload-panel" id="uploadPanel">
        <div class="upload-header">
            <div class="upload-title">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</div>
            <button class="close-upload" onclick="closeUploadPanel()">√ó</button>
        </div>
        <div class="upload-content">
            <form class="upload-form" id="uploadForm">
                <div class="form-group">
                    <label class="form-label">–§–∞–π–ª *</label>
                    <label class="file-input-label" id="fileLabel">
                        <div class="file-input-text">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞</div>
                        <div class="file-input-subtext">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 100MB</div>
                        <input type="file" id="fileInput">
                    </label>
                    <div class="file-info" id="fileInfo"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ *</label>
                    <input type="text" class="form-input" id="fileName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" maxlength="100" oninput="validateForm()">
                </div>

                <div class="form-group">
                    <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <textarea class="form-input" id="fileDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ñ–∞–π–ª–∞..." rows="3" maxlength="500"></textarea>
                </div>
            </form>
        </div>
        <div class="upload-footer">
            <button class="upload-button" id="uploadBtn" onclick="uploadFile()" disabled>
                –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
            </button>
        </div>
    </div>

    <!-- File Details Panel -->
    <div class="upload-overlay" id="fileDetailsOverlay" onclick="closeFileDetails()"></div>
    <div class="file-details-panel" id="fileDetailsPanel">
        <div class="file-details-header">
            <div class="upload-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–µ</div>
            <button class="file-details-close" onclick="closeFileDetails()">√ó</button>
        </div>
        <div class="file-details-content">
            <div class="file-preview">
                <div class="file-preview-icon" id="filePreviewIcon">üìÑ</div>
            </div>
            <div class="file-details-info">
                <div class="file-details-name" id="fileDetailsName">–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞</div>
                <div class="file-details-meta">
                    <div class="file-meta-item">
                        <span class="file-meta-label">–¢–∏–ø:</span>
                        <span class="file-meta-value" id="fileDetailsType">–§–∞–π–ª</span>
                    </div>
                    <div class="file-meta-item">
                        <span class="file-meta-label">–†–∞–∑–º–µ—Ä:</span>
                        <span class="file-meta-value" id="fileDetailsSize">0 MB</span>
                    </div>
                    <div class="file-meta-item">
                        <span class="file-meta-label">–ó–∞–≥—Ä—É–∂–µ–Ω:</span>
                        <span class="file-meta-value" id="fileDetailsDate">–°–µ–≥–æ–¥–Ω—è</span>
                    </div>
                    <div class="file-meta-item">
                        <span class="file-meta-label">–°—Å—ã–ª–∫–∞:</span>
                        <span class="file-meta-value" id="fileDetailsLink">–ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è"</span>
                    </div>
                </div>
            </div>
            <div class="file-actions">
                <button class="file-action-btn-large primary" onclick="shareFile()">
                    <span>üì§</span> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å—Å—ã–ª–∫–æ–π
                </button>
                <button class="file-action-btn-large secondary" onclick="copyFileLink()">
                    <span>üìã</span> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
                </button>
                <button class="file-action-btn-large secondary" onclick="deleteFile()" style="color: #ff3366;">
                    <span>üóëÔ∏è</span> –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª
                </button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDEXAMPLE1234567890",
            authDomain: "b-store-c3b22.firebaseapp.com",
            databaseURL: "https://b-store-c3b22-default-rtdb.firebaseio.com",
            projectId: "b-store-c3b22",
            storageBucket: "b-store-c3b22.appspot.com",
            messagingSenderId: "1234567890",
            appId: "1:1234567890:web:abcdef1234567890"
        };
        
        let app, database;
        try {
            app = firebase.initializeApp(firebaseConfig);
            database = firebase.database(app);
        } catch (error) {
            console.log("Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≤ –¥—Ä—É–≥–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏");
            database = firebase.database();
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        let tg = window.Telegram?.WebApp || {
            initDataUnsafe: {
                user: {
                    id: Date.now(),
                    username: "test_user",
                    first_name: "–¢–µ—Å—Ç",
                    last_name: "",
                    photo_url: "https://i.pravatar.cc/150?img=3"
                }
            },
            expand: () => {},
            openLink: (url) => window.open(url, '_blank'),
            showConfirm: (message, callback) => callback(window.confirm(message))
        };
        
        if (tg.expand) tg.expand();
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let currentUser = null;
        let files = [];
        let filteredFiles = [];
        let currentFilter = 'all';
        let selectedFile = null;
        let selectedFileForUpload = null;
        let currentView = 'grid';
        let userStorage = {
            used: 0, // –≤ –±–∞–π—Ç–∞—Ö
            total: 1024 * 1024 * 1024, // 1 GB –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            premium: false
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function initUser() {
            const tgUser = tg.initDataUnsafe?.user;
            currentUser = {
                id: tgUser?.id?.toString() || 'anonymous_' + Date.now(),
                username: tgUser?.username || 'user_' + Math.random().toString(36).substr(2, 9),
                firstName: tgUser?.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                lastName: tgUser?.last_name || '',
                photoUrl: tgUser?.photo_url || 'https://i.pravatar.cc/150?img=3'
            };
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–µ–º–∏—É–º —Å—Ç–∞—Ç—É—Å
            userStorage.premium = tg.initDataUnsafe?.user?.is_premium || false;
            userStorage.total = userStorage.premium ? 5 * 1024 * 1024 * 1024 : 1024 * 1024 * 1024;
            
            document.getElementById('userAvatar').src = currentUser.photoUrl;
            updateStorageDisplay();
            loadUserFiles();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø—Ä–µ–º–∏—É–º
            if (userStorage.premium) {
                document.querySelector('.header-title').textContent = 'Cloud Store ‚≠ê';
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
        function updateStorageDisplay() {
            const usedMB = (userStorage.used / 1024 / 1024).toFixed(1);
            const totalGB = (userStorage.total / 1024 / 1024 / 1024).toFixed(1);
            const percentage = (userStorage.used / userStorage.total) * 100;
            
            document.getElementById('storageUsed').textContent = `${usedMB} MB`;
            document.getElementById('storageTotal').textContent = `${totalGB} GB`;
            document.getElementById('storageProgress').style.width = `${percentage}%`;
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function switchTab(view) {
            currentView = view;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('gridTab').style.display = view === 'grid' ? 'block' : 'none';
            document.getElementById('listTab').style.display = view === 'list' ? 'block' : 'none';
            
            if (view === 'grid') {
                renderFilesGrid();
            } else {
                renderFilesList();
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function loadUserFiles() {
            if (!database) {
                showFilesError();
                return;
            }
            
            database.ref('user_files/' + currentUser.id).once('value')
                .then(snapshot => {
                    const filesData = snapshot.val();
                    
                    if (!filesData) {
                        files = [];
                        userStorage.used = 0;
                        updateStorageDisplay();
                        renderEmptyFiles();
                        return;
                    }
                    
                    files = Object.entries(filesData).map(([id, file]) => ({
                        id,
                        ...file
                    }));
                    
                    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–∏–π —Ä–∞–∑–º–µ—Ä
                    userStorage.used = files.reduce((total, file) => total + (file.size || 0), 0);
                    updateStorageDisplay();
                    
                    applyFilter();
                })
                .catch(error => {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤:", error);
                    showFilesError();
                });
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏
        function showFilesError() {
            const gridContainer = document.getElementById('filesGrid');
            const listContainer = document.getElementById('filesList');
            
            gridContainer.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">‚ö†Ô∏è</div>
                    <div class="empty-title">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
                    <div class="empty-text">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É</div>
                </div>
            `;
            
            listContainer.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">‚ö†Ô∏è</div>
                    <div class="empty-title">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
                    <div class="empty-text">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É</div>
                </div>
            `;
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        function renderEmptyFiles() {
            const gridContainer = document.getElementById('filesGrid');
            const listContainer = document.getElementById('filesList');
            
            gridContainer.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üìÅ</div>
                    <div class="empty-title">–§–∞–π–ª–æ–≤ –Ω–µ—Ç</div>
                    <div class="empty-text">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π —Ñ–∞–π–ª!</div>
                </div>
            `;
            
            listContainer.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üìÅ</div>
                    <div class="empty-title">–§–∞–π–ª–æ–≤ –Ω–µ—Ç</div>
                    <div class="empty-text">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π —Ñ–∞–π–ª!</div>
                </div>
            `;
        }
        
        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞
        function applyFilter() {
            switch (currentFilter) {
                case 'image':
                    filteredFiles = files.filter(file => 
                        file.type && (file.type.startsWith('image/') || 
                        ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'].some(ext => 
                            file.name.toLowerCase().endsWith(ext))));
                    break;
                case 'video':
                    filteredFiles = files.filter(file => 
                        file.type && (file.type.startsWith('video/') || 
                        ['.mp4', '.avi', '.mov', '.wmv', '.mkv'].some(ext => 
                            file.name.toLowerCase().endsWith(ext))));
                    break;
                case 'audio':
                    filteredFiles = files.filter(file => 
                        file.type && (file.type.startsWith('audio/') || 
                        ['.mp3', '.wav', '.ogg', '.m4a'].some(ext => 
                            file.name.toLowerCase().endsWith(ext))));
                    break;
                case 'document':
                    filteredFiles = files.filter(file => 
                        file.type && (file.type.startsWith('application/') || 
                        ['.pdf', '.doc', '.docx', '.xls', '.xlsx', '.ppt', '.pptx', '.txt'].some(ext => 
                            file.name.toLowerCase().endsWith(ext))));
                    break;
                default:
                    filteredFiles = [...files].sort((a, b) => b.timestamp - a.timestamp);
            }
            
            if (currentView === 'grid') {
                renderFilesGrid();
            } else {
                renderFilesList();
            }
        }
        
        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞
        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.getElementById('searchInput').value = '';
            document.getElementById('listSearchInput').value = '';
            
            applyFilter();
        }
        
        // –ü–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤
        function searchFiles() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (!query) {
                applyFilter();
                return;
            }
            
            const searchResults = filteredFiles.filter(file =>
                file.name.toLowerCase().includes(query) ||
                (file.description && file.description.toLowerCase().includes(query))
            );
            
            renderFilesGrid(searchResults);
        }
        
        function searchFilesList() {
            const query = document.getElementById('listSearchInput').value.toLowerCase().trim();
            
            if (!query) {
                applyFilter();
                return;
            }
            
            const searchResults = filteredFiles.filter(file =>
                file.name.toLowerCase().includes(query) ||
                (file.description && file.description.toLowerCase().includes(query))
            );
            
            renderFilesList(searchResults);
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –≤ –≤–∏–¥–µ —Å–µ—Ç–∫–∏
        function renderFilesGrid(filesToRender = filteredFiles) {
            const container = document.getElementById('filesGrid');
            
            if (filesToRender.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-title">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
                        <div class="empty-text">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filesToRender.map(file => createFileCard(file)).join('');
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ñ–∞–π–ª–∞
        function createFileCard(file) {
            const fileIcon = getFileIcon(file);
            const fileSize = formatFileSize(file.size);
            
            return `
                <div class="file-card" onclick="openFileDetails('${file.id}')">
                    <div class="file-icon">
                        ${fileIcon}
                    </div>
                    <div class="file-info">
                        <div class="file-name">${escapeHtml(file.name)}</div>
                        <div class="file-meta">
                            <span class="file-size">${fileSize}</span>
                            <span>üìÖ</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –≤ –≤–∏–¥–µ —Å–ø–∏—Å–∫–∞
        function renderFilesList(filesToRender = filteredFiles) {
            const container = document.getElementById('filesList');
            
            if (filesToRender.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-title">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
                        <div class="empty-text">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filesToRender.map(file => createFileListItem(file)).join('');
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤
        function createFileListItem(file) {
            const fileIcon = getFileIcon(file);
            const fileSize = formatFileSize(file.size);
            const fileDate = formatDate(file.timestamp);
            
            return `
                <div class="file-item" onclick="openFileDetails('${file.id}')">
                    <div class="file-item-icon">
                        ${fileIcon}
                    </div>
                    <div class="file-item-info">
                        <div class="file-item-name">${escapeHtml(file.name)}</div>
                        <div class="file-item-details">${fileSize} ‚Ä¢ ${fileDate}</div>
                    </div>
                    <div class="file-item-actions">
                        <button class="file-action-btn" onclick="shareFileDirect('${file.id}', event)">
                            üì§
                        </button>
                    </div>
                </div>
            `;
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –¥–ª—è —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
        function getFileIcon(file) {
            const name = file.name.toLowerCase();
            const type = file.type || '';
            
            if (type.startsWith('image/') || ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'].some(ext => name.endsWith(ext))) {
                return 'üñºÔ∏è';
            } else if (type.startsWith('video/') || ['.mp4', '.avi', '.mov', '.wmv', '.mkv'].some(ext => name.endsWith(ext))) {
                return 'üé•';
            } else if (type.startsWith('audio/') || ['.mp3', '.wav', '.ogg', '.m4a'].some(ext => name.endsWith(ext))) {
                return 'üéµ';
            } else if (type.startsWith('application/pdf') || name.endsWith('.pdf')) {
                return 'üìï';
            } else if (['.doc', '.docx'].some(ext => name.endsWith(ext))) {
                return 'üìÑ';
            } else if (['.xls', '.xlsx'].some(ext => name.endsWith(ext))) {
                return 'üìä';
            } else if (['.ppt', '.pptx'].some(ext => name.endsWith(ext))) {
                return 'üìΩÔ∏è';
            } else if (name.endsWith('.txt')) {
                return 'üìù';
            } else if (name.endsWith('.zip') || name.endsWith('.rar') || name.endsWith('.7z')) {
                return 'üì¶';
            } else {
                return 'üìÑ';
            }
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return '–°–µ–≥–æ–¥–Ω—è';
            } else if (diffDays === 1) {
                return '–í—á–µ—Ä–∞';
            } else if (diffDays < 7) {
                return `${diffDays} –¥–Ω–µ–π –Ω–∞–∑–∞–¥`;
            } else {
                return date.toLocaleDateString('ru-RU');
            }
        }
        
        // –û—Ç–∫—Ä—ã—Ç–∏–µ –¥–µ—Ç–∞–ª–µ–π —Ñ–∞–π–ª–∞
        function openFileDetails(fileId) {
            const file = files.find(f => f.id === fileId);
            if (!file) return;
            
            selectedFile = file;
            
            const fileIcon = getFileIcon(file);
            const fileSize = formatFileSize(file.size);
            const fileDate = formatDate(file.timestamp);
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
            let fileType = '–§–∞–π–ª';
            if (file.type) {
                if (file.type.startsWith('image/')) fileType = '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
                else if (file.type.startsWith('video/')) fileType = '–í–∏–¥–µ–æ';
                else if (file.type.startsWith('audio/')) fileType = '–ê—É–¥–∏–æ';
                else if (file.type.startsWith('application/pdf')) fileType = 'PDF –¥–æ–∫—É–º–µ–Ω—Ç';
                else if (file.type.startsWith('application/')) fileType = '–î–æ–∫—É–º–µ–Ω—Ç';
                else fileType = file.type;
            }
            
            document.getElementById('filePreviewIcon').textContent = fileIcon;
            document.getElementById('fileDetailsName').textContent = file.name;
            document.getElementById('fileDetailsType').textContent = fileType;
            document.getElementById('fileDetailsSize').textContent = fileSize;
            document.getElementById('fileDetailsDate').textContent = fileDate;
            document.getElementById('fileDetailsLink').textContent = file.url ? '–ì–æ—Ç–æ–≤–æ' : '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
            
            document.getElementById('fileDetailsOverlay').style.display = 'block';
            document.getElementById('fileDetailsPanel').classList.add('active');
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –¥–µ—Ç–∞–ª–µ–π —Ñ–∞–π–ª–∞
        function closeFileDetails() {
            document.getElementById('fileDetailsOverlay').style.display = 'none';
            document.getElementById('fileDetailsPanel').classList.remove('active');
            selectedFile = null;
        }
        
        // –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ñ–∞–π–ª–æ–º —á–µ—Ä–µ–∑ Telegram
        function shareFile() {
            if (!selectedFile || !selectedFile.url) {
                showToast("‚ùå –û—à–∏–±–∫–∞: –Ω–µ—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ñ–∞–π–ª");
                return;
            }
            
            const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(selectedFile.url)}&text=${encodeURIComponent(`–§–∞–π–ª: ${selectedFile.name}`)}`;
            tg.openLink(shareUrl);
        }
        
        // –ü—Ä—è–º–æ–π —à–∞—Ä–∏–Ω–≥ —Ñ–∞–π–ª–∞ –∏–∑ —Å–ø–∏—Å–∫–∞
        function shareFileDirect(fileId, event) {
            if (event) event.stopPropagation();
            
            const file = files.find(f => f.id === fileId);
            if (!file || !file.url) {
                showToast("‚ùå –û—à–∏–±–∫–∞: –Ω–µ—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ñ–∞–π–ª");
                return;
            }
            
            const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(file.url)}&text=${encodeURIComponent(`–§–∞–π–ª: ${file.name}`)}`;
            tg.openLink(shareUrl);
        }
        
        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ñ–∞–π–ª
        function copyFileLink() {
            if (!selectedFile || !selectedFile.url) {
                showToast("‚ùå –û—à–∏–±–∫–∞: –Ω–µ—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ñ–∞–π–ª");
                return;
            }
            
            navigator.clipboard.writeText(selectedFile.url)
                .then(() => {
                    showToast("‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞");
                })
                .catch(() => {
                    // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                    const textArea = document.createElement('textarea');
                    textArea.value = selectedFile.url;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showToast("‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞");
                });
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
        function deleteFile() {
            if (!selectedFile) return;
            
            tg.showConfirm(`–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª "${selectedFile.name}"?`, (confirmed) => {
                if (confirmed) {
                    deleteFileFromStorage(selectedFile.id);
                }
            });
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
        function deleteFileFromStorage(fileId) {
            if (!database) return;
            
            const file = files.find(f => f.id === fileId);
            if (!file) return;
            
            // –£–º–µ–Ω—å—à–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–æ–µ –º–µ—Å—Ç–æ
            userStorage.used -= file.size || 0;
            updateStorageDisplay();
            
            // –£–¥–∞–ª—è–µ–º –∏–∑ Firebase
            database.ref(`user_files/${currentUser.id}/${fileId}`).remove()
                .then(() => {
                    // –£–¥–∞–ª—è–µ–º –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—Å–∏–≤–∞
                    files = files.filter(f => f.id !== fileId);
                    filteredFiles = filteredFiles.filter(f => f.id !== fileId);
                    
                    showToast("üóëÔ∏è –§–∞–π–ª —É–¥–∞–ª–µ–Ω");
                    closeFileDetails();
                    
                    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ñ–∞–π–ª—ã
                    if (currentView === 'grid') {
                        renderFilesGrid();
                    } else {
                        renderFilesList();
                    }
                })
                .catch(error => {
                    console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞:", error);
                    showToast("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞");
                });
        }
        
        // –ü–∞–Ω–µ–ª—å –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
        function openUploadPanel() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –º–µ—Å—Ç–æ
            if (userStorage.used >= userStorage.total) {
                showToast(userStorage.premium ? 
                    "‚ùå –•—Ä–∞–Ω–∏–ª–∏—â–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ (5 GB)" : 
                    "‚ùå –•—Ä–∞–Ω–∏–ª–∏—â–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ (1 GB). –ü–æ–ª—É—á–∏—Ç–µ Telegram Premium –¥–ª—è 5 GB!");
                return;
            }
            
            document.getElementById('uploadOverlay').style.display = 'block';
            document.getElementById('uploadPanel').classList.add('active');
        }
        
        function closeUploadPanel() {
            document.getElementById('uploadOverlay').style.display = 'none';
            document.getElementById('uploadPanel').classList.remove('active');
            resetUploadForm();
        }
        
        // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã –∑–∞–≥—Ä—É–∑–∫–∏
        function resetUploadForm() {
            document.getElementById('uploadForm').reset();
            document.getElementById('fileInfo').textContent = '';
            selectedFileForUpload = null;
            validateForm();
        }
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
        function validateForm() {
            const name = document.getElementById('fileName').value.trim();
            const btn = document.getElementById('uploadBtn');
            btn.disabled = !name || !selectedFileForUpload;
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
                if (file.size > 100 * 1024 * 1024) {
                    showToast("‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 100MB)", "error");
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –º–µ—Å—Ç–æ
                if (userStorage.used + file.size > userStorage.total) {
                    showToast("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ");
                    return;
                }
                
                selectedFileForUpload = file;
                document.getElementById('fileName').value = file.name;
                document.getElementById('fileInfo').textContent = 
                    `${file.name} ‚Ä¢ ${formatFileSize(file.size)}`;
                document.getElementById('fileInfo').style.color = "var(--tg-theme-button-color, #2481cc)";
                validateForm();
            }
        });
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
        async function uploadFile() {
            if (!selectedFileForUpload) {
                showToast("‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏");
                return;
            }
            
            const name = document.getElementById('fileName').value.trim();
            if (!name) {
                showToast("‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞");
                return;
            }
            
            const btn = document.getElementById('uploadBtn');
            btn.disabled = true;
            btn.innerHTML = '<span style="animation: spin 1s linear infinite">‚åõ</span> –ó–∞–≥—Ä—É–∑–∫–∞...';
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                const fileUrl = await uploadToYeetYourFiles(selectedFileForUpload);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase
                const fileData = {
                    userId: currentUser.id,
                    username: currentUser.username || currentUser.firstName,
                    name: name,
                    description: document.getElementById('fileDescription').value.trim() || null,
                    type: selectedFileForUpload.type,
                    size: selectedFileForUpload.size,
                    url: fileUrl,
                    timestamp: Date.now()
                };
                
                const newFileRef = database.ref('user_files/' + currentUser.id).push();
                await newFileRef.set(fileData);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–æ–µ –º–µ—Å—Ç–æ
                userStorage.used += selectedFileForUpload.size;
                updateStorageDisplay();
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤
                const newFile = { id: newFileRef.key, ...fileData };
                files.unshift(newFile);
                
                showToast("‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!");
                closeUploadPanel();
                
                // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ñ–∞–π–ª—ã
                applyFilter();
                
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", error);
                showToast("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª';
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ YeetYourFiles
        async function uploadToYeetYourFiles(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            const response = await fetch('https://yyf.mubilop.com/api/upload', {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                throw new Error(`Upload failed: ${response.status}`);
            }
            
            const result = await response.json();
            return 'https://yyf.mubilop.com' + result.fileUrl;
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function openTelegramProfile() {
            if (currentUser.username) {
                tg.openLink(`https://t.me/${currentUser.username}`);
            } else {
                showToast("–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            initUser();
            
            // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
            if (database) {
                database.ref('user_files/' + currentUser.id).on('value', () => {
                    loadUserFiles();
                });
            }
        });
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        window.switchTab = switchTab;
        window.openUploadPanel = openUploadPanel;
        window.closeUploadPanel = closeUploadPanel;
        window.validateForm = validateForm;
        window.uploadFile = uploadFile;
        window.searchFiles = searchFiles;
        window.searchFilesList = searchFilesList;
        window.setFilter = setFilter;
        window.openFileDetails = openFileDetails;
        window.closeFileDetails = closeFileDetails;
        window.shareFile = shareFile;
        window.shareFileDirect = shareFileDirect;
        window.copyFileLink = copyFileLink;
        window.deleteFile = deleteFile;
        window.openTelegramProfile = openTelegramProfile;
    </script>
</body>
</html>
